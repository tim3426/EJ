
SELECT SUB.[CONSTITUENTID], 
	(COALESCE(SUB.[RECENTINTENTION], 0) 
		+ COALESCE(SUB.OLDERINTENTION, 0) 
		+ COALESCE(SUB.PGHOTLIST, 0) 
		+ COALESCE(SUB.[INQUIRY], 0)
		+COALESCE(SUB.[LOYAL], 0) 
		+ COALESCE(SUB.[ANNUITY], 0)
		+ COALESCE(SUB.[LASTQUALIFIED],0)) [RANK1], 
	(COALESCE(SUB.[RECENTINTENTION], 0) 
		+ COALESCE(SUB.OLDERINTENTION, 0) 
		+ COALESCE(SUB.PGHOTLIST, 0) 
		+ COALESCE(SUB.[INQUIRY], 0)
		+COALESCE(SUB.[LOYAL], 0) 
		+ COALESCE(SUB.[ANNUITY], 0) 
		+ COALESCE(SUB.[LASTQUALIFIED],0)
		+ COALESCE(SUB.[DQS], 0) 
		+ COALESCE(SUB.[AGERANGE], 0) 
		+ COALESCE(SUB.[CHILDREN], 0) 
		+ COALESCE(SUB.[PROPERTY], 0) 
		+COALESCE(SUB.[RECENTGIVER], 0)) [RANKPLUS], 
	[SUB].[TOTALPG] [Planned gifts total],
	[SUB].[LOOKUPID] [BBEC ID],
	[SUB].[NAME] [Name],
	[SUB].AGE [Age], 
	[SUB].CHILDREN [Children],
	[SUB].[ADDRESS] [Address],
	[SUB].CITY [City], 
	[SUB].[SORT_NAME] [SORT],
	[SUB].STATE [State], 
	[SUB].ZIP [Zip], 
	[SUB].[EMAIL] [Email], 
	[SUB].[PHONE] [Phone], 
	[SUB].PG [Evergreen Council], 
	[SUB].[DISTINCTGIVING] [Distinct years],
	[SUB].[CONSECUTIVEGIVING] [Consecutive years],
	[SUB].[LASTDATE] [Last gift], 
	[SUB].[FIRSTDATE] [First gift], 
	[SUB].[TOTALGIVING] [Total giving],
	[SUB].[TOTALINQUIRIES] [Total inquiries],
	[SUB].[PROPERTIES] [Properties],
	[SUB].[LASTPGDATE] [Last PG contact date],
	[SUB].[LASTPGPERSON] [Last PG staff contact],
	[SUB].[LASTPGCONTACT] [Last PG contact],
	[SUB].YEAR_0_REC [Current fiscal], 
	[SUB].YEAR_1_REC [Prior fiscal], 
	[SUB].EJ_FIVE_YEAR_CAP [5 year capacity],
	[SUB].EJ_EST_WEALTH [Estimated wealth],
	[SUB].LIFETIME_INTERACTIONS [Total interactions], 
	[SUB].[RECENTINTENTION] [Recent intention],
	[SUB].[OLDERINTENTION] [Older intention],
	[SUB].[PGHOTLIST] [Hotlist],
	[SUB].[LASTINQUIRY] [Last inquiry], 
	[SUB].QUALDATE [Last qualified inq],
	[SUB].[ANNUITY] [CGAandCRT],	
	[SUB].[DQS] [DQ]
FROM (
		SELECT DISTINCT 
		SUM(PGACCEPTED.EXPECTEDGIFTAMOUNT) [TOTALPG],
		[C].CONSTITUENTID [CONSTITUENTID], 
		[C].NAME [NAME],
		[C].[LOOKUPID],
		[C]. ADDRESS,
		[C].CITY, 
		[C].SORT_NAME,
		[C].STATE, 
		[C].ZIP, 
		[C].[EMAIL], 
		[C].[PHONE], 
		[C].AGE, 
		[C].CHILDREN,
		[C].PG, 
		[DISTINCT].VALUE [DISTINCTGIVING], 
		[CONSECUTIVE].VALUE [CONSECUTIVEGIVING],
		[C].LATESTDATE [LASTDATE], 
		[C].FIRSTDATE [FIRSTDATE], 
		[C].LIFETIME_RECGIVING [TOTALGIVING],
		INQUIRYCOUNT.INQUIRIES [TOTALINQUIRIES],
		[PROPERTY].REALESTATENUMBERCONFIRMED [PROPERTIES],
		LASTPGCONTACT.ACTUALDATE [LASTPGDATE],
		LASTPGCONTACT.NAME [LASTPGPERSON],
		LASTPGCONTACT.OBJECTIVE [LASTPGCONTACT],
		[C].YEAR_0_REC, 
		[C].YEAR_1_REC, 
		[C].EJ_FIVE_YEAR_CAP,
		[C].EJ_EST_WEALTH,
		[C].LIFETIME_INTERACTIONS, 
		[LASTINQUIRY].INQUIRYDATE [LASTINQUIRY],
		[LASTQUALIFIED].QUALIFIEDDATE [QUALDATE],
		CASE WHEN PGPENDING.EXPECTEDGIFTAMOUNT = 0 THEN 30
		ELSE NULL
		END [RECENTINTENTION],
		CASE WHEN PGACCEPTED.EXPECTEDGIFTAMOUNT = 0 THEN 5
		END [OLDERINTENTION],
		CASE WHEN [C].EJ_PROSPECT_FLAG = 'PG Flagged/Not Reviewed' THEN 15
		END [PGHOTLIST],
		[C].EJ_PROSPECT_FLAG, 
		CASE WHEN LASTQUALIFIED.[QUALIFIEDDATE] >= DATEADD(month, -2, GETDATE()) THEN 15
			WHEN LASTQUALIFIED.[QUALIFIEDDATE] >= DATEADD(YEAR, -1, GETDATE()) THEN 10
			WHEN LASTQUALIFIED.[QUALIFIEDDATE] < DATEADD(YEAR,-1, GETDATE()) THEN 5
			ELSE NULL
		END [LASTQUALIFIED],
		CASE WHEN LASTINQUIRY.[INQUIRYDATE] >= DATEADD(day, -14, GETDATE()) THEN 18
			WHEN LASTINQUIRY.[INQUIRYDATE] >= DATEADD(MONTH, -1, GETDATE()) THEN 10
			WHEN LASTINQUIRY.[INQUIRYDATE] >= DATEADD(YEAR, -1, GETDATE()) THEN 5
			WHEN LASTINQUIRY.[INQUIRYDATE] < DATEADD(YEAR,-1, GETDATE()) THEN 2
			ELSE NULL
		END [INQUIRY], 
		CASE WHEN CONSECUTIVE.VALUE >= 25 THEN 25
			WHEN CONSECUTIVE.VALUE > 10 THEN 10 
			WHEN CONSECUTIVE.VALUE BETWEEN 4 AND 9 THEN 5 
		END [LOYAL],
		CASE WHEN PGACCEPTED.VEHICLE IN ( 'Charitable gift annuity', 'Charitable remainder trust') THEN 5
		END [ANNUITY],	
		CASE WHEN DQED.ID IS NOT NULL THEN 5	
		END [DQS], 
		CASE WHEN C.AGE BETWEEN 70 AND 89 THEN 5
		END [AGERANGE], 
		CASE WHEN [C].YEAR_0_REC > 0 THEN 5
			WHEN [C].YEAR_1_REC > 0 THEN 5
		END [RECENTGIVER], 
		CASE WHEN C.CHILDREN = 0 THEN 5
		END [POINTSCHILDREN],
		CASE WHEN [PROPERTY].ID IS NOT NULL THEN 5
		END [PROPERTY]
		FROM EJ_CONSTITUENT_MASTER C
		LEFT OUTER JOIN V_QUERY_PROSPECT MANAGED ON MANAGED.ID = C.CONSTITUENTID 
			AND MANAGED.PROSPECTSTATUSCODE IN 
				('IDENTIFIED',
				'ACCEPTED',
				'QUALIFICATION',
				'CONNECTING'
				)
		LEFT OUTER JOIN V_QUERY_PROSPECT [DQED] ON [DQED].ID = C.CONSTITUENTID 
			AND [DQED].PROSPECTSTATUSCODE IN 
				('Disqualified',
				'Pending Engagement',
				'Reassess'
				)
		LEFT OUTER JOIN V_QUERY_PLANNEDGIFT [PGPENDING] ON [PGPENDING].CONSTITUENTID = C.CONSTITUENTID 
			AND [PGPENDING].STATUS = 'Response pending'
		LEFT OUTER JOIN V_QUERY_PLANNEDGIFT [PGACCEPTED] ON [PGACCEPTED].CONSTITUENTID = C.CONSTITUENTID 
			AND [PGACCEPTED].STATUS = 'Accepted'
		LEFT OUTER JOIN CONSTITUENT MANAGER ON MANAGER.ID = MANAGED.PROSPECTMANAGERFUNDRAISERID 
		LEFT OUTER JOIN [DBO].[V_QUERY_SMARTFIELDBAF5B52C98BA40769C9BB9C890113401] AS [DISTINCT] ON [C].CONSTITUENTID = [DISTINCT].[ID]
		LEFT OUTER JOIN [DBO].[V_QUERY_SMARTFIELDDD629FE3B0FB4575853080EDE20544E6] AS [CONSECUTIVE] ON [C].[CONSTITUENTID] = [CONSECUTIVE].[ID]
		LEFT OUTER JOIN [DBO].[V_QUERY_WEALTH] AS [PROPERTY] ON [C].[CONSTITUENTID] = [PROPERTY].[ID]
			AND [PROPERTY].[REALESTATENUMBERCONFIRMED] >= 5
		LEFT OUTER JOIN (
			SELECT * 
			FROM (	SELECT 
						[I].ACTUALDATE, 
						[O].NAME, 
						[OTEAM].BUSINESSUNIT, 
						[I].OBJECTIVE, 
						[I].CONSTITUENTID [CONSTITUENTID], 
						ROW_NUMBER() OVER (PARTITION BY I.CONSTITUENTID ORDER BY I.CONSTITUENTID,I.DATE desc) AS ROWNUMBER
					FROM V_QUERY_INTERACTIONALL I 
					LEFT OUTER JOIN V_QUERY_CONSTITUENT [O] ON [O].ID = I.OWNERID
					LEFT OUTER JOIN (
						SELECT
							[CONSTITUENT].[ID] [CONSTITUENTID],
							[DBO].[UFN_BUSINESSUNITCODE_GETDESCRIPTION](ORGANIZATIONPOSITION.BUSINESSUNITCODEID) [BUSINESSUNIT]
						FROM [DBO].[ORGANIZATIONHIERARCHY]
						INNER JOIN DBO.ORGANIZATIONPOSITION ON ORGANIZATIONPOSITION.ID = ORGANIZATIONHIERARCHY.ID
						LEFT OUTER JOIN DBO.ORGANIZATIONPOSITIONHOLDER ON ORGANIZATIONPOSITIONHOLDER.POSITIONID = ORGANIZATIONPOSITION.ID
						LEFT OUTER JOIN DBO.CONSTITUENT ON CONSTITUENT.ID = ORGANIZATIONPOSITIONHOLDER.CONSTITUENTID
						WHERE ORGANIZATIONPOSITIONHOLDER.DATETO IS NULL
						) [OTEAM] ON O.[ID] = OTEAM.[CONSTITUENTID]
					WHERE I.STATUS = 'COMPLETED'
					AND [OTEAM].BUSINESSUNIT = 'Planned gifts'
					)Y 
			WHERE Y.ROWNUMBER = 1
			)[LASTPGCONTACT] ON [LASTPGCONTACT].CONSTITUENTID = C.CONSTITUENTID 
		LEFT OUTER JOIN (
			SELECT * 
			FROM (SELECT  
					[I].CONSTITUENTID [CONSTITUENTID],
					[I].ACTUALDATE [INQUIRYDATE],
					ROW_NUMBER() OVER (PARTITION BY I.CONSTITUENTID ORDER BY I.CONSTITUENTID,I.DATE desc) AS ROWNUMBER
					FROM V_QUERY_INTERACTIONALL I 
					WHERE [I].SUBCATEGORY_TRANSLATION = 'PG Inquiry'
						AND [I].STATUS = 'Completed'
					) Y
			WHERE Y.ROWNUMBER = 1 
			)[LASTINQUIRY] ON [LASTINQUIRY].CONSTITUENTID = C.CONSTITUENTID
		LEFT OUTER JOIN (
			SELECT * 
			FROM(
					SELECT  
						[I].CONSTITUENTID [CONSTITUENTID],
						I.ID,
						[IRESPONSE].DATE [QUALIFIEDDATE],
						ROW_NUMBER() OVER (PARTITION BY I.CONSTITUENTID ORDER BY I.CONSTITUENTID,IRESPONSE.DATE DESC) AS ROWNUMBER
					FROM  [DBO].[V_QUERY_INTERACTIONALL] I
						INNER JOIN [DBO].[V_QUERY_INTERACTIONRESPONSE] AS IRESPONSE ON I.[ID] = IRESPONSE.[INTERACTIONID]
						INNER JOIN [DBO].[V_QUERY_RESPONSE] AS R ON IRESPONSE.[RESPONSEID] = R.[ID] 
							AND R.RESPONSE_CATEGORY_TRANSLATION = 'PG QUALIFIED INQUIRY'
				UNION
					SELECT [MAILING].CONSTITUENTID [CONSTITUENTID],
						MAILING.ID,
						[ARESPONSE].DATE [QUALIFIEDDATE],
						ROW_NUMBER() OVER (PARTITION BY MAILING.CONSTITUENTID ORDER BY MAILING.CONSTITUENTID,ARESPONSE.DATE DESC) AS ROWNUMBER
					FROM  [DBO].[V_QUERY_CONSTITUENTAPPEAL] AS [MAILING]
						INNER JOIN [DBO].[V_QUERY_CONSTITUENTAPPEALRESPONSE] AS [ARESPONSE] ON [MAILING].[ID] = [ARESPONSE].[CONSTITUENTAPPEALID]
						INNER JOIN [DBO].[V_QUERY_RESPONSE] AS [R] ON [ARESPONSE].[RESPONSEID] = [R].[ID]
							AND R.RESPONSE_CATEGORY_TRANSLATION = 'PG QUALIFIED INQUIRY'
					) SUB
			WHERE SUB.ROWNUMBER = 1 
			ORDER BY SUB.QUALIFIEDDATE DESC OFFSET 0 rows
			)[LASTQUALIFIED] ON [LASTQUALIFIED].CONSTITUENTID = C.CONSTITUENTID
		LEFT OUTER JOIN (
			SELECT CONSTITUENTID
			FROM [DBO].[V_QUERY_CONSTITUENTAPPEAL] [APPEAL]
			LEFT OUTER JOIN [DBO].[V_QUERY_CONSTITUENTAPPEALRESPONSE] AS [APPEALRESPONSE] ON [APPEAL].[ID] = [APPEALRESPONSE].[CONSTITUENTAPPEALID]
			INNER JOIN [DBO].[V_QUERY_RESPONSE] AS [RESPONSE] ON [APPEALRESPONSE].[RESPONSEID] = [RESPONSE].[ID]
			WHERE [RESPONSE].[RESPONSE_CATEGORY_TRANSLATION] = 'PG RESPONSE'
				AND [RESPONSE].[RESPONSE] = N'NOT INTERESTED'
				)AS [NOINTEREST] ON [C].[CONSTITUENTID] = [NOINTEREST].[CONSTITUENTID]
		LEFT OUTER JOIN (
			SELECT DISTINCT
				[I].CONSTITUENTID [CONSTITUENTID],
				COUNT(I.ID) [INQUIRIES]
			FROM V_QUERY_INTERACTIONALL I 
			WHERE [I].SUBCATEGORY_TRANSLATION = 'PG Inquiry'
				AND [I].STATUS = 'Completed'
			GROUP BY [I].CONSTITUENTID
			) [INQUIRYCOUNT] ON INQUIRYCOUNT.CONSTITUENTID = C.[CONSTITUENTID]
		WHERE [C].DECEASED = 0 
		AND [C].INACTIVE = 0 
		AND MANAGED.ID IS NULL 
		AND NOINTEREST.CONSTITUENTID IS NULL 
		GROUP BY 
		[C].CONSTITUENTID , 
		[C].NAME ,
		[C].[LOOKUPID],
		[C]. ADDRESS,
		[C].CITY, 
		[C].SORT_NAME,
		[C].STATE, 
		[C].ZIP, 
		[C].[EMAIL], 
		[C].[PHONE], 
		[C].AGE, 
		[C].CHILDREN,
		[C].PG, 
		[DISTINCT].VALUE , 
		[CONSECUTIVE].VALUE ,
		[C].LATESTDATE , 
		[C].FIRSTDATE , 
		[C].LIFETIME_RECGIVING ,
		INQUIRYCOUNT.INQUIRIES ,
		[PROPERTY].REALESTATENUMBERCONFIRMED ,
		LASTPGCONTACT.ACTUALDATE ,
		LASTPGCONTACT.NAME ,
		LASTPGCONTACT.OBJECTIVE ,
		[C].YEAR_0_REC, 
		[C].YEAR_1_REC, 
		[C].EJ_FIVE_YEAR_CAP,
		[C].EJ_EST_WEALTH,
		[C].LIFETIME_INTERACTIONS, 
		[LASTINQUIRY].INQUIRYDATE ,
		[LASTQUALIFIED].QUALIFIEDDATE,
		CASE WHEN PGPENDING.EXPECTEDGIFTAMOUNT = 0 THEN 30
		ELSE NULL
		END ,
		CASE WHEN PGACCEPTED.EXPECTEDGIFTAMOUNT = 0 THEN 5
		END ,
		CASE WHEN [C].EJ_PROSPECT_FLAG = 'PG Flagged/Not Reviewed' THEN 15
		END ,
		[C].EJ_PROSPECT_FLAG, 
		CASE WHEN LASTQUALIFIED.[QUALIFIEDDATE] >= DATEADD(month, -2, GETDATE()) THEN 15
			WHEN LASTQUALIFIED.[QUALIFIEDDATE] >= DATEADD(YEAR, -1, GETDATE()) THEN 10
			WHEN LASTQUALIFIED.[QUALIFIEDDATE] < DATEADD(YEAR,-1, GETDATE()) THEN 5
			ELSE NULL
		END ,
		CASE WHEN LASTINQUIRY.[INQUIRYDATE] >= DATEADD(day, -14, GETDATE()) THEN 18
			WHEN LASTINQUIRY.[INQUIRYDATE] >= DATEADD(MONTH, -1, GETDATE()) THEN 10
			WHEN LASTINQUIRY.[INQUIRYDATE] >= DATEADD(YEAR, -1, GETDATE()) THEN 5
			WHEN LASTINQUIRY.[INQUIRYDATE] < DATEADD(YEAR,-1, GETDATE()) THEN 2
			ELSE NULL
			END,
		CASE WHEN CONSECUTIVE.VALUE >= 25 THEN 25
			WHEN CONSECUTIVE.VALUE > 10 THEN 10 
			WHEN CONSECUTIVE.VALUE BETWEEN 4 AND 9 THEN 5 
		END ,
		CASE WHEN PGACCEPTED.VEHICLE IN ( 'Charitable gift annuity', 'Charitable remainder trust') THEN 5
		END ,	
		CASE WHEN DQED.ID IS NOT NULL THEN 5	
		END , 
		CASE WHEN C.AGE BETWEEN 70 AND 89 THEN 5
		END , 
		CASE WHEN [C].YEAR_0_REC > 0 THEN 5
			WHEN [C].YEAR_1_REC > 0 THEN 5
		END , 
		CASE WHEN C.CHILDREN = 0 THEN 5
		END ,
		CASE WHEN [PROPERTY].ID IS NOT NULL THEN 5
		END 
		
		)SUB
WHERE (COALESCE(SUB.[RECENTINTENTION], 0) 
	+ COALESCE(SUB.OLDERINTENTION, 0) 
	+ COALESCE(SUB.PGHOTLIST, 0) 
	+ COALESCE(SUB.[INQUIRY], 0)
	+ COALESCE(SUB.[LOYAL], 0) 
	+ COALESCE(SUB.[ANNUITY], 0)
	+ COALESCE(SUB.[LASTQUALIFIED],0)) > 0	


	

