SELECT SUB.[CONSTITUENTID], 
	(COALESCE(SUB.[RECENTINTENTION], 0) 
		+ COALESCE(SUB.OLDERINTENTION, 0) 
		+ COALESCE(SUB.PGHOTLIST, 0) 
		+ COALESCE(SUB.[INQUIRY], 0)
		+ COALESCE(SUB.[LOYAL], 0) 
		+ COALESCE(SUB.[ANNUITY], 0) 
		+ COALESCE(SUB.[NOCHILDRENRESPONSE],0)
		+ COALESCE(SUB.[DQS], 0) 
		+ COALESCE(SUB.[AGERANGE], 0) 
		+ COALESCE(SUB.[CHILDREN], 0) 
		+ COALESCE(SUB.[PROPERTY], 0) 
		+ COALESCE(SUB.[RECENTGIVER], 0)) [RANKPLUS], 
	[SUB].[TOTALPG] [Planned gifts total],
	[SUB].[LOOKUPID] [BBEC ID],
	[SUB].[NAME] [Name],
	[SUB].AGE [Age], 
	[SUB].CHILDREN [Children],
	[SUB].[ADDRESS] [Address],
	[SUB].CITY [City], 
	[SUB].[SORT_NAME] [SORT],
	[SUB].STATE [State], 
	[SUB].ZIP [Zip], 
	[SUB].[EMAIL] [Email], 
	[SUB].[PHONE] [Phone], 
	[SUB].PG [Evergreen Council], 
	[SUB].[DISTINCTGIVING] [Distinct years],
	[SUB].[CONSECUTIVEGIVING] [Consecutive years],
	[SUB].[LASTDATE] [Last gift], 
	[SUB].[FIRSTDATE] [First gift], 
	[SUB].[TOTALGIVING] [Total giving],
	[SUB].[TOTALINQUIRIES] [Total inquiries],
	[SUB].[ONEWAYS] [Attempts],
	[SUB].[PROPERTIES] [Properties],
	[SUB].[LASTPGDATE] [Last PG contact date],
	[SUB].[LASTPGPERSON] [Last PG staff contact],
	[SUB].[LASTPGCONTACT] [Last PG contact],
	[SUB].YEAR_0_REC [Current fiscal], 
	[SUB].YEAR_1_REC [Prior fiscal], 
	[SUB].EJ_FIVE_YEAR_CAP [5 year capacity],
	[SUB].EJ_EST_WEALTH [Estimated wealth],
	[SUB].LIFETIME_INTERACTIONS [Total interactions], 
	[SUB].[RECENTINTENTION] [Recent intention],
	[SUB].[OLDERINTENTION] [Older intention],
	[SUB].[PGHOTLIST] [Hotlist],
	[SUB].[LASTINQUIRY] [Last inquiry], 
	[SUB].[ANNUITY] [CGAandCRT],	
	[SUB].[NOCHILDRENRESPONSE] [No Children Response],
	[SUB].[DQS] [DQ],
	[SUB].[CONSTITUENCY] [Primary constituency],
	case when [SUB].[NOCALL] is not NULL then 'No calls' end [No call], 
	case when [SUB].[NOEMAIL] is not NULL then 'No email' end [No email], 
	case when [SUB].[NOVISIT] is not NULL then 'No visits' end [No visits], 
	case when [SUB].[NOMAIL] is not NULL then 'No mail' end [No mail], 
	case when [SUB].[NOCONTACT] is not NULL then 'No contact' end [No contact], 
	(COALESCE(SUB.[RECENTINTENTION], 0) 
		+ COALESCE(SUB.OLDERINTENTION, 0) 
		+ COALESCE(SUB.PGHOTLIST, 0) 
		+ COALESCE(SUB.[NOCHILDRENRESPONSE], 0)
		+ COALESCE(SUB.[INQUIRY], 0)
		+ COALESCE(SUB.[LOYAL], 0) 
		+ COALESCE(SUB.[ANNUITY], 0)) [RANK1]
FROM (
		SELECT DISTINCT 
		SUM(PGACCEPTED.EXPECTEDGIFTAMOUNT) [TOTALPG],
		[C].CONSTITUENTID [CONSTITUENTID], 
		[C].NAME [NAME],
		[C].[LOOKUPID],
		[C]. ADDRESS,
		[C].CITY, 
		[C].SORT_NAME,
		[C].STATE, 
		[C].ZIP, 
		[C].[EMAIL], 
		[C].[PHONE], 
		[C].AGE, 
		[C].CHILDREN,
		[C].PG, 
		[DISTINCT].VALUE [DISTINCTGIVING], 
		[CONSECUTIVE].VALUE [CONSECUTIVEGIVING],
		[C].LASTGIFT_DATE [LASTDATE], 
		[C].FIRSTGIFT_DATE [FIRSTDATE], 
		[C].LIFETIME_CASH_GIVING [TOTALGIVING],
		INQUIRYCOUNT.INQUIRIES [TOTALINQUIRIES],
		[ATTEMPTCOUNT].[ONEWAYS],
		[PROPERTY].REALESTATENUMBERCONFIRMED [PROPERTIES],
		LASTPGCONTACT.ACTUALDATE [LASTPGDATE],
		LASTPGCONTACT.NAME [LASTPGPERSON],
		LASTPGCONTACT.OBJECTIVE [LASTPGCONTACT],
		[C].ANNUAL_SUMMARY_CASH_YEAR_0 [YEAR_0_REC], 
		[C].ANNUAL_SUMMARY_CASH_YEAR_1 [YEAR_1_REC], 
		[C].EJ_FIVE_YEAR_CAPACITY [EJ_FIVE_YEAR_CAP],
		[C].EJ_EST_WEALTH,
		[C].LIFETIME_INTERACTIONS, 
		[LASTINQUIRY].INQUIRYDATE [LASTINQUIRY],
		CASE WHEN PGPENDING.EXPECTEDGIFTAMOUNT = 0 THEN 30
		ELSE NULL
		END [RECENTINTENTION],
		CASE WHEN PGACCEPTED.EXPECTEDGIFTAMOUNT = 0 THEN 5
		END [OLDERINTENTION],
		CASE WHEN [C].EJ_PROSPECT_FLAG = 'PG Flagged/Not Reviewed' THEN 15
		END [PGHOTLIST],
		[C].EJ_PROSPECT_FLAG, 
		CASE WHEN LASTINQUIRY.[INQUIRYDATE] >= DATEADD(MONTH, -1, GETDATE()) THEN 10
			WHEN LASTINQUIRY.[INQUIRYDATE] >= DATEADD(YEAR, -1, GETDATE()) THEN 5
			WHEN LASTINQUIRY.[INQUIRYDATE] < DATEADD(YEAR,-1, GETDATE()) THEN 2
			ELSE NULL
		END [INQUIRY], 
		CASE WHEN [DISTINCT].VALUE >= 25 
			AND ([C].ANNUAL_SUMMARY_CASH_YEAR_0 > 0 
				OR [C].ANNUAL_SUMMARY_ACCURAL_YEAR_1 > 0) THEN 25
			WHEN [DISTINCT].VALUE > 15 
			AND ([C].ANNUAL_SUMMARY_CASH_YEAR_0 > 0 
				OR [C].ANNUAL_SUMMARY_ACCURAL_YEAR_1 > 0)THEN 10 
		END [LOYAL],
		CASE WHEN [ACCEPTEDANNUITY].VEHICLE in ( 'Charitable gift annuity', 'Charitable remainder trust') THEN 5
		END [ANNUITY],	
		CASE WHEN [NOCHILDREN].CONSTITUENTID IS NOT NULL THEN 30
		END [NOCHILDRENRESPONSE],
		CASE WHEN C.PROSPECTSTATUS in ('Disqualified','Pending Engagement','Reassess') THEN 5	
		END [DQS], 
		CASE WHEN C.AGE BETWEEN 70 AND 89 THEN 5
		END [AGERANGE], 
		CASE WHEN [C].ANNUAL_SUMMARY_CASH_YEAR_0 > 0 THEN 5
			WHEN [C].ANNUAL_SUMMARY_CASH_YEAR_1 > 0 THEN 5
		END [RECENTGIVER], 
		CASE WHEN C.CHILDREN = 0 THEN 5
		END [POINTSCHILDREN],
		CASE WHEN [PROPERTY].ID IS NOT NULL THEN 5
		END [PROPERTY], 
		[C].PRIMARY_CONSTITUENCY [CONSTITUENCY],
		[NOCALL].ID [NOCALL], 
		[NOMAIL].ID [NOMAIL], 
		NOEMAIL.ID [NOEMAIL], 
		NOVISIT.ID [NOVISIT],
		NOCONTACT.ID [NOCONTACT]
		FROM EJ_CONSTITUENT_HISTORY C
		LEFT OUTER JOIN V_QUERY_PLANNEDGIFT [PGPENDING] ON [PGPENDING].CONSTITUENTID = C.CONSTITUENTID 
			AND [PGPENDING].STATUS = 'Response pending'
		LEFT OUTER JOIN V_QUERY_PLANNEDGIFT [ACCEPTEDANNUITY] ON [ACCEPTEDANNUITY].CONSTITUENTID = C.CONSTITUENTID 
			AND [ACCEPTEDANNUITY].STATUS = 'Accepted' 
			AND [ACCEPTEDANNUITY].VEHICLE in ( 'Charitable gift annuity', 'Charitable remainder trust')
		LEFT OUTER JOIN V_QUERY_PLANNEDGIFT [PGACCEPTED] ON [PGACCEPTED].CONSTITUENTID = C.CONSTITUENTID 
			AND [PGACCEPTED].STATUS = 'Accepted' 
			AND [PGACCEPTED].VEHICLE not in ( 'Charitable gift annuity', 'Charitable remainder trust')
			AND [PGACCEPTED].EXPECTEDGIFTAMOUNT = 0
		LEFT JOIN DBO.[UFN_ADHOCQUERYIDSET_AF7B491C_8DF5_4A0B_B9BC_6A7B2092B23A]() AS [NOCALL] ON [C].[CONSTITUENTID] = [NOCALL].ID
		LEFT JOIN DBO.[UFN_ADHOCQUERYIDSET_12ED23CC_D3EB_484C_8417_8EEBF200F252]() AS [NOCONTACT] ON [C].[CONSTITUENTID] = [NOCONTACT].ID
		LEFT JOIN DBO.[UFN_ADHOCQUERYIDSET_E0B1DEBC_CF0C_42B8_80C9_9D5733218107]() AS [NOEMAIL] ON [C].[CONSTITUENTID] = [NOEMAIL].ID
		LEFT JOIN DBO.[UFN_ADHOCQUERYIDSET_26891D1B_50D3_4B0E_9D93_C8A74BB80287]() AS [NOMAIL] ON [C].[CONSTITUENTID] = [NOMAIL].ID
		LEFT JOIN DBO.[UFN_ADHOCQUERYIDSET_2407554A_9826_428B_A716_469BE1F72CD7]() AS [NOVISIT] ON [C].[CONSTITUENTID] = [NOVISIT].ID
		LEFT OUTER JOIN [DBO].[V_QUERY_SMARTFIELDBAF5B52C98BA40769C9BB9C890113401] AS [DISTINCT] ON [C].CONSTITUENTID = [DISTINCT].[ID]
		LEFT OUTER JOIN [DBO].[V_QUERY_SMARTFIELDDD629FE3B0FB4575853080EDE20544E6] AS [CONSECUTIVE] ON [C].[CONSTITUENTID] = [CONSECUTIVE].[ID]
		LEFT OUTER JOIN [DBO].[V_QUERY_WEALTH] AS [PROPERTY] ON [C].[CONSTITUENTID] = [PROPERTY].[ID]
			AND [PROPERTY].[REALESTATENUMBERCONFIRMED] >= 5
		LEFT OUTER JOIN (
			SELECT * 
			FROM (	SELECT 
						[I].ACTUALDATE, 
						[O].NAME, 
						[OTEAM].BUSINESSUNIT, 
						[I].OBJECTIVE, 
						[I].CONSTITUENTID [CONSTITUENTID], 
						ROW_NUMBER() OVER (PARTITION BY I.CONSTITUENTID ORDER BY I.CONSTITUENTID,I.DATE desc) AS ROWNUMBER
					FROM V_QUERY_INTERACTIONALL I 
					LEFT OUTER JOIN V_QUERY_CONSTITUENT [O] ON [O].ID = I.OWNERID
					LEFT OUTER JOIN (
						SELECT
							[CONSTITUENT].[ID] [CONSTITUENTID],
							[DBO].[UFN_BUSINESSUNITCODE_GETDESCRIPTION](ORGANIZATIONPOSITION.BUSINESSUNITCODEID) [BUSINESSUNIT]
						FROM [DBO].[ORGANIZATIONHIERARCHY]
						INNER JOIN DBO.ORGANIZATIONPOSITION ON ORGANIZATIONPOSITION.ID = ORGANIZATIONHIERARCHY.ID
						LEFT OUTER JOIN DBO.ORGANIZATIONPOSITIONHOLDER ON ORGANIZATIONPOSITIONHOLDER.POSITIONID = ORGANIZATIONPOSITION.ID
						LEFT OUTER JOIN DBO.CONSTITUENT ON CONSTITUENT.ID = ORGANIZATIONPOSITIONHOLDER.CONSTITUENTID
						WHERE ORGANIZATIONPOSITIONHOLDER.DATETO IS NULL
						) [OTEAM] ON O.[ID] = OTEAM.[CONSTITUENTID]
					WHERE I.STATUS = 'COMPLETED'
					AND [OTEAM].BUSINESSUNIT = 'Planned gifts'
					)X 
			WHERE X.ROWNUMBER = 1
			)[LASTPGCONTACT] ON [LASTPGCONTACT].CONSTITUENTID = C.CONSTITUENTID 
		LEFT OUTER JOIN (
			SELECT * 
			FROM (SELECT  
					[I].CONSTITUENTID [CONSTITUENTID],
					[I].ACTUALDATE [INQUIRYDATE],
					ROW_NUMBER() OVER (PARTITION BY I.CONSTITUENTID ORDER BY I.CONSTITUENTID,I.DATE desc) AS ROWNUMBER
					FROM V_QUERY_INTERACTIONALL I 
					WHERE [I].SUBCATEGORY_TRANSLATION = 'PG Inquiry'
						AND [I].STATUS = 'Completed'
					) Y
			WHERE Y.ROWNUMBER = 1 
			)[LASTINQUIRY] ON [LASTINQUIRY].CONSTITUENTID = C.CONSTITUENTID
		LEFT OUTER JOIN (
			SELECT CONSTITUENTID
			FROM [DBO].[V_QUERY_CONSTITUENTAPPEAL] [APPEAL]
			LEFT OUTER JOIN [DBO].[V_QUERY_CONSTITUENTAPPEALRESPONSE] AS [APPEALRESPONSE] ON [APPEAL].[ID] = [APPEALRESPONSE].[CONSTITUENTAPPEALID]
			INNER JOIN [DBO].[V_QUERY_RESPONSE] AS [RESPONSE] ON [APPEALRESPONSE].[RESPONSEID] = [RESPONSE].[ID]
			WHERE [RESPONSE].[RESPONSE_CATEGORY_TRANSLATION] = 'PG RESPONSE'
				AND [RESPONSE].[RESPONSE] = N'NOT INTERESTED'
				)AS [NOINTEREST] ON [C].[CONSTITUENTID] = [NOINTEREST].[CONSTITUENTID]
		LEFT OUTER JOIN (
			SELECT * 
			FROM (SELECT  
					[I].CONSTITUENTID [CONSTITUENTID],
					[I].ACTUALDATE [NOCHILDRENDATE],
					ROW_NUMBER() OVER (PARTITION BY [I].CONSTITUENTID ORDER BY [I].CONSTITUENTID,[I].ACTUALDATE desc) AS ROWNUMBER
					FROM V_QUERY_INTERACTION I 
					INNER JOIN V_QUERY_INTERACTIONRESPONSE as IR on IR.INTERACTIONID = I.ID
					WHERE RESPONSEID = '7C111EF9-FA20-44A3-AD11-B05BE181E818'
					) Z
			WHERE Z.ROWNUMBER = 1 
		) AS [NOCHILDREN] ON [C].[CONSTITUENTID] = [NOCHILDREN].[CONSTITUENTID]
		LEFT OUTER JOIN (
			SELECT DISTINCT
				[I].CONSTITUENTID [CONSTITUENTID],
				COUNT(I.ID) [INQUIRIES]
			FROM V_QUERY_INTERACTIONALL I 
			WHERE [I].SUBCATEGORY_TRANSLATION = 'PG Inquiry'
				AND [I].STATUS = 'Completed'
			GROUP BY [I].CONSTITUENTID
			) [INQUIRYCOUNT] ON INQUIRYCOUNT.CONSTITUENTID = C.[CONSTITUENTID]
		LEFT OUTER JOIN (
			SELECT DISTINCT
				[I].CONSTITUENTID [CONSTITUENTID],
				COUNT(I.ID) [ONEWAYS]
			FROM V_QUERY_INTERACTIONALL I 
			WHERE [I].SUBCATEGORY_TRANSLATION = 'One Way'
				AND [I].STATUS = 'Completed'
				AND [I].ACTUALDATE >= DATEADD(MONTH, -6, GETDATE())
			GROUP BY [I].CONSTITUENTID
			) [ATTEMPTCOUNT] ON [ATTEMPTCOUNT].CONSTITUENTID = C.[CONSTITUENTID]
		WHERE [C].DECEASED = 0 
		AND [C].INACTIVE = 0 
		AND (C.PROSPECTSTATUS NOT IN ('Accepted', 'Connecting', 'Identified', 'Qualification') 
			OR C.PROSPECTSTATUS IS NULL)  
		AND NOINTEREST.CONSTITUENTID IS NULL 
		GROUP BY 
		[C].CONSTITUENTID , 
		[C].NAME ,
		[C].[LOOKUPID],
		[C]. ADDRESS,
		[C].CITY, 
		[C].SORT_NAME,
		[C].STATE, 
		[C].ZIP, 
		[C].[EMAIL], 
		[C].[PHONE], 
		[C].AGE, 
		[C].CHILDREN,
		[C].PG, 
		[DISTINCT].VALUE , 
		[CONSECUTIVE].VALUE ,
		[C].LASTGIFT_DATE , 
		[C].FIRSTGIFT_DATE , 
		[C].LIFETIME_CASH_GIVING ,
		INQUIRYCOUNT.INQUIRIES ,
		[ATTEMPTCOUNT].[ONEWAYS],
		[PROPERTY].REALESTATENUMBERCONFIRMED ,
		LASTPGCONTACT.ACTUALDATE ,
		LASTPGCONTACT.NAME ,
		LASTPGCONTACT.OBJECTIVE ,
		[C].ANNUAL_SUMMARY_CASH_YEAR_0, 
		[C].ANNUAL_SUMMARY_CASH_YEAR_1, 
		[C].EJ_FIVE_YEAR_CAPACITY,
		[C].EJ_EST_WEALTH,
		[C].LIFETIME_INTERACTIONS, 
		[LASTINQUIRY].INQUIRYDATE ,
		CASE WHEN PGPENDING.EXPECTEDGIFTAMOUNT = 0 THEN 30
		ELSE NULL
		END ,
		CASE WHEN PGACCEPTED.EXPECTEDGIFTAMOUNT = 0 THEN 5
		END ,
		CASE WHEN [C].EJ_PROSPECT_FLAG = 'PG Flagged/Not Reviewed' THEN 15
		END ,
		[C].EJ_PROSPECT_FLAG, 
		CASE WHEN LASTINQUIRY.[INQUIRYDATE] >= DATEADD(MONTH, -1, GETDATE()) THEN 10
			WHEN LASTINQUIRY.[INQUIRYDATE] >= DATEADD(YEAR, -1, GETDATE()) THEN 5
			WHEN LASTINQUIRY.[INQUIRYDATE] < DATEADD(YEAR,-1, GETDATE()) THEN 2
			ELSE NULL
			END,
		CASE WHEN [DISTINCT].VALUE >= 25 
			AND ([C].ANNUAL_SUMMARY_CASH_YEAR_0 > 0 
				OR [C].ANNUAL_SUMMARY_ACCURAL_YEAR_1 > 0) THEN 25
			WHEN [DISTINCT].VALUE > 15 
			AND ([C].ANNUAL_SUMMARY_CASH_YEAR_0 > 0 
				OR [C].ANNUAL_SUMMARY_ACCURAL_YEAR_1 > 0)THEN 10 
		END ,
			CASE WHEN [ACCEPTEDANNUITY].VEHICLE in ( 'Charitable gift annuity', 'Charitable remainder trust') THEN 5
			END,
		CASE WHEN [NOCHILDREN].CONSTITUENTID IS NOT NULL THEN 30
			ELSE NULL
			END,
		CASE WHEN C.PROSPECTSTATUS in ('Disqualified','Pending Engagement','Reassess') THEN 5	
		END , 
		CASE WHEN C.AGE BETWEEN 70 AND 89 THEN 5
		END , 
		CASE WHEN [C].ANNUAL_SUMMARY_CASH_YEAR_0 > 0 THEN 5
			WHEN [C].ANNUAL_SUMMARY_CASH_YEAR_1 > 0 THEN 5
		END , 
		CASE WHEN C.CHILDREN = 0 THEN 5
		END ,
		CASE WHEN [PROPERTY].ID IS NOT NULL THEN 5
		END ,
		[C].PRIMARY_CONSTITUENCY,
		[NOCALL].ID, 
		[NOMAIL].ID, 
		NOEMAIL.ID, 
		NOVISIT.ID,
		NOCONTACT.ID
		
		)SUB
WHERE (COALESCE(SUB.[RECENTINTENTION], 0) 
	+ COALESCE(SUB.OLDERINTENTION, 0) 
	+ COALESCE(SUB.PGHOTLIST, 0) 
	+ COALESCE(SUB.[NOCHILDRENRESPONSE], 0)
	+ COALESCE(SUB.[INQUIRY], 0)
	+ COALESCE(SUB.[LOYAL], 0) 
	+ COALESCE(SUB.[ANNUITY], 0)) > 0	
