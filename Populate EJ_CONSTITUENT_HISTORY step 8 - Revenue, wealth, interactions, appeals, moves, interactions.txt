use EJDEVO;

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
SET QUOTED_IDENTIFIER ON
------------------------------------------------------
--                Begin step EIGHT              --
------------------------------------------------------

update EJ_CONSTITUENT_HISTORY 
set
			ANNUAL_SUMMARY_CASH_YEAR_0 = SUB.ANNUAL_SUMMARY_CASH_YEAR_0,
			ANNUAL_SUMMARY_CASH_YEAR_1 = SUB.ANNUAL_SUMMARY_CASH_YEAR_1,
			ANNUAL_SUMMARY_CASH_YEAR_2 = SUB.ANNUAL_SUMMARY_CASH_YEAR_2 ,
			ANNUAL_SUMMARY_CASH_YEAR_3 = SUB.ANNUAL_SUMMARY_CASH_YEAR_3,
			ANNUAL_SUMMARY_CASH_YEAR_4 = SUB.ANNUAL_SUMMARY_CASH_YEAR_4 ,
			ANNUAL_SUMMARY_CASH_YEAR_5 = SUB.ANNUAL_SUMMARY_CASH_YEAR_5,
			ANNUAL_SUMMARY_CASH_YEAR_6 = SUB.ANNUAL_SUMMARY_CASH_YEAR_6,
			ANNUAL_SUMMARY_CASH_YEAR_7 = SUB.ANNUAL_SUMMARY_CASH_YEAR_7,
			ANNUAL_SUMMARY_CASH_YEAR_8 = SUB.ANNUAL_SUMMARY_CASH_YEAR_8,
			ANNUAL_SUMMARY_CASH_YEAR_9 = SUB.ANNUAL_SUMMARY_CASH_YEAR_9,
			ANNUAL_SUMMARY_CASH_YEAR_10 = SUB.ANNUAL_SUMMARY_CASH_YEAR_10,
			ANNUAL_SUMMARY_ACCURAL_YEAR_0 = SUB.ANNUAL_SUMMARY_ACCURAL_YEAR_0,
			ANNUAL_SUMMARY_ACCURAL_YEAR_1 = SUB.ANNUAL_SUMMARY_ACCURAL_YEAR_1,
			ANNUAL_SUMMARY_ACCURAL_YEAR_2 = SUB.ANNUAL_SUMMARY_ACCURAL_YEAR_2,
			ANNUAL_SUMMARY_ACCURAL_YEAR_3 = SUB.ANNUAL_SUMMARY_ACCURAL_YEAR_3,
			ANNUAL_SUMMARY_ACCURAL_YEAR_4 = SUB.ANNUAL_SUMMARY_ACCURAL_YEAR_4,
			ANNUAL_SUMMARY_ACCURAL_YEAR_5 = SUB.ANNUAL_SUMMARY_ACCURAL_YEAR_5,
			ANNUAL_SUMMARY_ACCURAL_YEAR_6 = SUB.ANNUAL_SUMMARY_ACCURAL_YEAR_6,
			ANNUAL_SUMMARY_ACCURAL_YEAR_7 = SUB.ANNUAL_SUMMARY_ACCURAL_YEAR_7,
			ANNUAL_SUMMARY_ACCURAL_YEAR_8 = SUB.ANNUAL_SUMMARY_ACCURAL_YEAR_8,
			ANNUAL_SUMMARY_ACCURAL_YEAR_9 = SUB.ANNUAL_SUMMARY_ACCURAL_YEAR_9,
			ANNUAL_SUMMARY_ACCURAL_YEAR_10 = SUB.ANNUAL_SUMMARY_ACCURAL_YEAR_10,
			MGL = SUB.MGL,
			PGL = SUB.PGL,
			TGR = SUB.TGR,
			TGRSCORE = SUB.TGRSCORE,
			POWERSEGMENT = SUB.POWERSEGMENT,
			PGS = SUB.PGS,
			LOYALTYINSIGHTS = SUB.LOYALTYINSIGHTS,
			ASSETSCONFIRMED = SUB.ASSETSCONFIRMED,
			AFFLUENCEINDICATOR = SUB.AFFLUENCEINDICATOR,
			EJ_FIVE_YEAR_CAPACITY = SUB.EJ_FIVE_YEAR_CAPACITY,
			EJ_AFFINITY = SUB.EJ_AFFINITY,
			EJ_EST_WEALTH = SUB.EJ_EST_WEALTH,
			EJ_INCLINATION = SUB.EJ_INCLINATION,
			EJ_PROSPECT_FLAG = SUB.EJ_PROSPECT_FLAG,
			WEALTHX_NET_WORTH = SUB.WEALTHX_NET_WORTH,
			APPEAL_0 = SUB.APPEAL_0,
			APPEAL_1 = SUB.APPEAL_1,
			APPEAL_2 = SUB.APPEAL_2,
			APPEAL_3 = SUB.APPEAL_3,
			APPEAL_4 = SUB.APPEAL_4,
			APPEAL_6 = SUB.APPEAL_6,
			APPEAL_7 = SUB.APPEAL_7,
			APPEAL_8 = SUB.APPEAL_8,
			APPEAL_9 = SUB.APPEAL_9,
			APPEAL_10 = SUB.APPEAL_10,
			FIRST_APPEAL = SUB.FIRST_APPEAL,
			LATEST_APPEAL = SUB.LATEST_APPEAL,
			INTERACTION_0 = SUB.INTERACTION_0,
			INTERACTION_1 = SUB.INTERACTION_1,
			INTERACTION_2 = SUB.INTERACTION_2,
			INTERACTION_3 = SUB.INTERACTION_3,
			INTERACTION_4 = SUB.INTERACTION_4,
			INTERACTION_5 = SUB.INTERACTION_5,
			INTERACTION_6 = SUB.INTERACTION_6,
			INTERACTION_7 = SUB.INTERACTION_7,
			INTERACTION_8 = SUB.INTERACTION_8,
			INTERACTION_9 = SUB.INTERACTION_9,
			INTERACTION_10 = SUB.INTERACTION_10,
			LIFETIME_INTERACTIONS = SUB.LIFETIME_INTERACTIONS,
			FIRST_INTERACTION = SUB.FIRST_INTERACTION,
			LATEST_INTERACTION = SUB.LATEST_INTERACTION,
			STEPS_0 = SUB.STEPS_0,
			STEPS_1 = SUB.STEPS_1,
			STEPS_2 = SUB.STEPS_2,
			STEPS_3 = SUB.STEPS_3,
			STEPS_4 = SUB.STEPS_4,
			STEPS_5 = SUB.STEPS_5,
			STEPS_6 = SUB.STEPS_6,
			STEPS_7 = SUB.STEPS_7,
			STEPS_8 = SUB.STEPS_8,
			STEPS_9 = SUB.STEPS_9,
			STEPS_10 = SUB.STEPS_10,
			LIFETIME_STEPS = SUB.LIFETIME_STEPS,
			FIRST_STEP = SUB.FIRST_STEP,
			LATEST_STEP = SUB.LATEST_STEP,
			FIRST_EVENT_DATE = SUB.FIRST_EVENT_DATE,
			ASKS = SUB.ASKS,
			DECLINEASKS = SUB.DECLINEASKS,
			VISITS = SUB.VISITS,
			LETTEROFINQUIRY = SUB.LETTEROFINQUIRY,
			REALESTATE_CONFIRMED = SUB.REALESTATE_CONFIRMED,
			PROPERTIESCONFIRMED = SUB.PROPERTIESCONFIRMED,
			EST_WEALTHRANGE = SUB.EST_WEALTHRANGE,
			EST_WEALTHVALUE = SUB.EST_WEALTHVALUE,
			SOLICITAMOUNT = SUB.SOLICITAMOUNT,
			LAST_INTERACTION_DATE = SUB.LAST_INTERACTION_DATE,
			LAST_INTERACTION_STAGE = SUB.LAST_INTERACTION_STAGE,
			LAST_MOVE_DATE = SUB.LAST_MOVE_DATE,
			LAST_MOVE_STAGE = SUB.LAST_MOVE_STAGE,
			ANNUAL_SUMMARY_CASH_YEAR_0_COUNT = SUB.ANNUAL_SUMMARY_CASH_YEAR_0_COUNT,
			ANNUAL_SUMMARY_CASH_YEAR_1_COUNT = SUB.ANNUAL_SUMMARY_CASH_YEAR_1_COUNT,
			ANNUAL_SUMMARY_CASH_YEAR_2_COUNT = SUB.ANNUAL_SUMMARY_CASH_YEAR_2_COUNT,
			ANNUAL_SUMMARY_CASH_YEAR_3_COUNT = SUB.ANNUAL_SUMMARY_CASH_YEAR_3_COUNT,
			ANNUAL_SUMMARY_CASH_YEAR_4_COUNT = SUB.ANNUAL_SUMMARY_CASH_YEAR_4_COUNT,
			ANNUAL_SUMMARY_CASH_YEAR_5_COUNT = SUB.ANNUAL_SUMMARY_CASH_YEAR_5_COUNT,
			ANNUAL_SUMMARY_CASH_YEAR_6_COUNT = SUB.ANNUAL_SUMMARY_CASH_YEAR_6_COUNT,
			ANNUAL_SUMMARY_CASH_YEAR_7_COUNT = SUB.ANNUAL_SUMMARY_CASH_YEAR_7_COUNT,
			ANNUAL_SUMMARY_CASH_YEAR_8_COUNT = SUB.ANNUAL_SUMMARY_CASH_YEAR_8_COUNT,
			ANNUAL_SUMMARY_CASH_YEAR_9_COUNT = SUB.ANNUAL_SUMMARY_CASH_YEAR_9_COUNT,
			ANNUAL_SUMMARY_CASH_YEAR_10_COUNT = SUB.ANNUAL_SUMMARY_CASH_YEAR_10_COUNT

from (
		select
			CONSTITUENT.ID CONSTITUENTID,
			ANNUAL_SUMMARY_CASH.YEAR_0  ANNUAL_SUMMARY_CASH_YEAR_0,
			ANNUAL_SUMMARY_CASH.YEAR_1  ANNUAL_SUMMARY_CASH_YEAR_1,
			ANNUAL_SUMMARY_CASH.YEAR_2  ANNUAL_SUMMARY_CASH_YEAR_2,
			ANNUAL_SUMMARY_CASH.YEAR_3  ANNUAL_SUMMARY_CASH_YEAR_3,
			ANNUAL_SUMMARY_CASH.YEAR_4  ANNUAL_SUMMARY_CASH_YEAR_4,
			ANNUAL_SUMMARY_CASH.YEAR_5  ANNUAL_SUMMARY_CASH_YEAR_5,
			ANNUAL_SUMMARY_CASH.YEAR_6  ANNUAL_SUMMARY_CASH_YEAR_6,
			ANNUAL_SUMMARY_CASH.YEAR_7  ANNUAL_SUMMARY_CASH_YEAR_7,
			ANNUAL_SUMMARY_CASH.YEAR_8  ANNUAL_SUMMARY_CASH_YEAR_8,
			ANNUAL_SUMMARY_CASH.YEAR_9  ANNUAL_SUMMARY_CASH_YEAR_9,
			ANNUAL_SUMMARY_CASH.YEAR_10  ANNUAL_SUMMARY_CASH_YEAR_10,
			ANNUAL_SUMMARY_ACCRUAL.YEAR_0  ANNUAL_SUMMARY_ACCURAL_YEAR_0,
			ANNUAL_SUMMARY_ACCRUAL.YEAR_1  ANNUAL_SUMMARY_ACCURAL_YEAR_1,
			ANNUAL_SUMMARY_ACCRUAL.YEAR_2  ANNUAL_SUMMARY_ACCURAL_YEAR_2,
			ANNUAL_SUMMARY_ACCRUAL.YEAR_3  ANNUAL_SUMMARY_ACCURAL_YEAR_3,
			ANNUAL_SUMMARY_ACCRUAL.YEAR_4  ANNUAL_SUMMARY_ACCURAL_YEAR_4,
			ANNUAL_SUMMARY_ACCRUAL.YEAR_5  ANNUAL_SUMMARY_ACCURAL_YEAR_5,
			ANNUAL_SUMMARY_ACCRUAL.YEAR_6  ANNUAL_SUMMARY_ACCURAL_YEAR_6,
			ANNUAL_SUMMARY_ACCRUAL.YEAR_7  ANNUAL_SUMMARY_ACCURAL_YEAR_7,
			ANNUAL_SUMMARY_ACCRUAL.YEAR_8  ANNUAL_SUMMARY_ACCURAL_YEAR_8,
			ANNUAL_SUMMARY_ACCRUAL.YEAR_9  ANNUAL_SUMMARY_ACCURAL_YEAR_9,
			ANNUAL_SUMMARY_ACCRUAL.YEAR_10  ANNUAL_SUMMARY_ACCURAL_YEAR_10,
			MODELING.MGL,
			MODELING.PGL,
			MODELING.TGR,
			MODELING.TGRSCORE,
			MODELING.POWERSEGMENT,
			MODELING.PGS,
			MODELING.LOYALTYINSIGHTS,
			MODELING.ASSETSCONFIRMED,
			MODELING.AFFLUENCEINDICATOR,
			MODELING.EJ_FIVE_YEAR_CAP EJ_FIVE_YEAR_CAPACITY,
			MODELING.EJ_AFFINITY,
			MODELING.EJ_EST_WEALTH,
			MODELING.EJ_INCLINATION,
			MODELING.EJ_PROSPECT_FLAG,
			MODELING.WEALTHX_NET_WORTH,
			APPEALS.APPEAL_0,
			APPEALS.APPEAL_1,
			APPEALS.APPEAL_2,
			APPEALS.APPEAL_3,
			APPEALS.APPEAL_4,
			APPEALS.APPEAL_5,
			APPEALS.APPEAL_6,
			APPEALS.APPEAL_7,
			APPEALS.APPEAL_8,
			APPEALS.APPEAL_9,
			APPEALS.APPEAL_10,
			APPEALS.FIRST_APPEAL,
			APPEALS.LATEST_APPEAL,
			INTERACTIONS.COMMUNICATION_0 INTERACTION_0,
			INTERACTIONS.COMMUNICATION_1 INTERACTION_1,
			INTERACTIONS.COMMUNICATION_2 INTERACTION_2,
			INTERACTIONS.COMMUNICATION_3 INTERACTION_3,
			INTERACTIONS.COMMUNICATION_4 INTERACTION_4,
			INTERACTIONS.COMMUNICATION_5 INTERACTION_5,
			INTERACTIONS.COMMUNICATION_6 INTERACTION_6,
			INTERACTIONS.COMMUNICATION_7 INTERACTION_7,
			INTERACTIONS.COMMUNICATION_8 INTERACTION_8,
			INTERACTIONS.COMMUNICATION_9 INTERACTION_9,
			INTERACTIONS.COMMUNICATION_10 INTERACTION_10,
			INTERACTIONS.LIFETIME_COMMUNICATION LIFETIME_INTERACTIONS,
			INTERACTIONS.FIRST_COMMUNICATION FIRST_INTERACTION,
			INTERACTIONS.LATEST_COMMUNICATION LATEST_INTERACTION,
			STEPS.COMMUNICATION_0 STEPS_0,
			STEPS.COMMUNICATION_1 STEPS_1,
			STEPS.COMMUNICATION_2 STEPS_2,
			STEPS.COMMUNICATION_3 STEPS_3,
			STEPS.COMMUNICATION_4 STEPS_4,
			STEPS.COMMUNICATION_5 STEPS_5,
			STEPS.COMMUNICATION_6 STEPS_6,
			STEPS.COMMUNICATION_7 STEPS_7,
			STEPS.COMMUNICATION_8 STEPS_8,
			STEPS.COMMUNICATION_9 STEPS_9,
			STEPS.COMMUNICATION_10 STEPS_10,
			STEPS.LIFETIME_COMMUNICATION LIFETIME_STEPS,
			STEPS.FIRST_COMMUNICATION FIRST_STEP,
			STEPS.LATEST_COMMUNICATION LATEST_STEP,
			FIRST_EVENT.STARTDATE FIRST_EVENT_DATE,
			INTERACTIONCOUNT.ASKS,
			INTERACTIONCOUNT.DECLINEASKS,
			INTERACTIONCOUNT.VISITS,
			INTERACTIONCOUNT.LOIS LETTEROFINQUIRY,
			MODELING.REALESTATE_CONFIRMED,
			MODELING.PROPERTIESCONFIRMED,
			MODELING.EST_WEALTHRANGE,
			MODELING.EST_WEALTHVALUE,
			SOLICITAMOUNT.ASKAMOUNT SOLICITAMOUNT,
			LASTINTERACTION.[DATE] LAST_INTERACTION_DATE,
			LASTINTERACTION.STAGE LAST_INTERACTION_STAGE,
			LASTMOVE.[DATE] LAST_MOVE_DATE,
			LASTMOVE.STAGE LAST_MOVE_STAGE,
			ANNUAL_SUMMARY_CASH.YEAR_0_COUNT ANNUAL_SUMMARY_CASH_YEAR_0_COUNT,
			ANNUAL_SUMMARY_CASH.YEAR_1_COUNT ANNUAL_SUMMARY_CASH_YEAR_1_COUNT,
			ANNUAL_SUMMARY_CASH.YEAR_2_COUNT ANNUAL_SUMMARY_CASH_YEAR_2_COUNT,
			ANNUAL_SUMMARY_CASH.YEAR_3_COUNT ANNUAL_SUMMARY_CASH_YEAR_3_COUNT,
			ANNUAL_SUMMARY_CASH.YEAR_4_COUNT ANNUAL_SUMMARY_CASH_YEAR_4_COUNT,
			ANNUAL_SUMMARY_CASH.YEAR_5_COUNT ANNUAL_SUMMARY_CASH_YEAR_5_COUNT,
			ANNUAL_SUMMARY_CASH.YEAR_6_COUNT ANNUAL_SUMMARY_CASH_YEAR_6_COUNT,
			ANNUAL_SUMMARY_CASH.YEAR_7_COUNT ANNUAL_SUMMARY_CASH_YEAR_7_COUNT,
			ANNUAL_SUMMARY_CASH.YEAR_8_COUNT ANNUAL_SUMMARY_CASH_YEAR_8_COUNT,
			ANNUAL_SUMMARY_CASH.YEAR_9_COUNT ANNUAL_SUMMARY_CASH_YEAR_9_COUNT,
			ANNUAL_SUMMARY_CASH.YEAR_10_COUNT ANNUAL_SUMMARY_CASH_YEAR_10_COUNT
		from (select distinct CONSTITUENT.ID, CONSTITUENT.[NAME] from V_QUERY_CONSTITUENT CONSTITUENT) CONSTITUENT
		left join (
					select
						EVENTREGISTRANT.CONSTITUENTID,
						min([EVENT].STARTDATE) STARTDATE
					from V_QUERY_EVENTREGISTRANT EVENTREGISTRANT
					inner join V_QUERY_EVENT [EVENT] on EVENTREGISTRANT.EVENTID = [EVENT].ID
					where EVENTREGISTRANT.ATTENDED = 1
					group by EVENTREGISTRANT.CONSTITUENTID
				  ) FIRST_EVENT on CONSTITUENT.ID = FIRST_EVENT.CONSTITUENTID
		left join ( 
					select
						CONSTITUENT.ID CONSTITUENTID,
						count(distinct case when TOTALINTERACTIONS.SUBCATEGORY = 'Ask' and TOTALINTERACTIONS.STATUS = 'Completed' then TOTALINTERACTIONS.INTERACTIONID end) ASKS,
						count(distinct case when TOTALINTERACTIONS.SUBCATEGORY = 'Ask' and TOTALINTERACTIONS.STATUS in ('Canceled', 'Declined') then TOTALINTERACTIONS.INTERACTIONID end) DECLINEASKS,
						count(distinct case when (TOTALINTERACTIONS.CONTACTMETHOD = 'Visit' or TOTALINTERACTIONS.SUBCATEGORY = 'Visit' ) then TOTALINTERACTIONS.INTERACTIONID end) VISITS,
						count(distinct case when TOTALINTERACTIONS.CONTACTMETHOD = 'Letter of Inquiry' then TOTALINTERACTIONS.INTERACTIONID end) LOIS
					from (select distinct CONSTITUENT.ID, CONSTITUENT.[NAME] from V_QUERY_CONSTITUENT CONSTITUENT) CONSTITUENT
					inner join (select 
								PROSPECT.ID PROSPECTID,
								INTERACTION.ID INTERACTIONID,
								INTERACTION.SUBCATEGORY_TRANSLATION [SUBCATEGORY],
								INTERACTION.CONTACTMETHOD,
								INTERACTION.STATUS,
								INTERACTION.ACTUALDATE [DATE]
								from [dbo].[V_QUERY_INTERACTIONALL] as INTERACTION
									left join [dbo].[V_QUERY_PROSPECT] PROSPECT on INTERACTION.CONSTITUENTID = PROSPECT.ID
									left join [dbo].[V_QUERY_PROSPECTPLAN] as PROSPECTPLAN on INTERACTION.[PROSPECTPLANID] = PROSPECTPLAN.[ID]
								where INTERACTION.[STATUS] = 'Completed'
									and INTERACTION.DATE between convert(date, concat(case when month(getDate()) > 6 then year(getDate()) else year(getDate())-1 end, '-07-01')) and getDate() 
								) TOTALINTERACTIONS ON CONSTITUENT.ID = TOTALINTERACTIONS.PROSPECTID
					group by CONSTITUENT.ID
					) INTERACTIONCOUNT on CONSTITUENT.ID = INTERACTIONCOUNT.CONSTITUENTID
		left join (select  distinct
							PROSPECT.ID PROSPECTID,
							sum(OPPORTUNITY.ASKAMOUNT) ASKAMOUNT
								from [dbo].[V_QUERY_INTERACTIONALL] as INTERACTION
								left join [dbo].[V_QUERY_PROSPECT] PROSPECT on INTERACTION.CONSTITUENTID = PROSPECT.ID
								left join [dbo].[V_QUERY_PROSPECTPLAN] as PROSPECTPLAN on INTERACTION.[PROSPECTPLANID] = PROSPECTPLAN.[ID]
								left join [dbo].[V_QUERY_OPPORTUNITY] as OPPORTUNITY on PROSPECTPLAN.[ID] = OPPORTUNITY.[PROSPECTPLANID]
								where INTERACTION.SUBCATEGORY_TRANSLATION = 'Ask'
									and INTERACTION.[STATUS] = 'Completed'
									and PROSPECTPLAN.PROSPECTPLANTYPECODEID <> '98F61944-2900-46E5-8C95-C1EE8BDA4593' --Earthjustice Action plan c(4)
									and INTERACTION.[DATE] between convert(date, concat(case when month(getDate()) > 6 then year(getDate()) else year(getDate())-1 end, '-07-01')) and getDate()
								group by PROSPECT.ID
					) SOLICITAMOUNT ON CONSTITUENT.ID = SOLICITAMOUNT.PROSPECTID
		left join (select
						*
				   from (select
							INTERACTION.CONSTITUENTID,
							INTERACTION.[DATE],
							INTERACTION.CATEGORY_TRANSLATION STAGE,
							INTERACTION.SUBCATEGORY_TRANSLATION,
							RANK() over (partition by INTERACTION.CONSTITUENTID order by INTERACTION.[DATE] desc, INTERACTION.CATEGORY_TRANSLATION desc, INTERACTION.SUBCATEGORY_TRANSLATION desc, INTERACTION.ID desc) LAST_INTERACTION
						from V_QUERY_INTERACTIONALL INTERACTION
						where INTERACTION.STATUS = 'Completed'
						) RANKED
					where RANKED.LAST_INTERACTION = 1
				   ) LASTINTERACTION on CONSTITUENT.ID = LASTINTERACTION.CONSTITUENTID
		left join (select
						*
				   from (select
							INTERACTION.CONSTITUENTID,
							INTERACTION.[DATE],
							INTERACTION.CATEGORY_TRANSLATION STAGE,
							INTERACTION.SUBCATEGORY_TRANSLATION,
							RANK() over (partition by INTERACTION.CONSTITUENTID order by INTERACTION.[DATE] desc, INTERACTION.CATEGORY_TRANSLATION desc, INTERACTION.SUBCATEGORY_TRANSLATION desc, INTERACTION.ID desc) LAST_INTERACTION
						from V_QUERY_INTERACTIONALL INTERACTION
						where INTERACTION.PROSPECTPLANID is not null
						and INTERACTION.STATUS = 'Completed'
						) RANKED
					where RANKED.LAST_INTERACTION = 1
				   ) LASTMOVE on CONSTITUENT.ID = LASTMOVE.CONSTITUENTID
		left join (select * from EJ_CONSTITUENT_COMMUNICATIONS COMMUNICATIONS where COMMUNICATIONS.TYPE = 'Interaction') INTERACTIONS on CONSTITUENT.ID = INTERACTIONS.CONSTITUENTID
		left join (select * from EJ_CONSTITUENT_COMMUNICATIONS COMMUNICATIONS where COMMUNICATIONS.TYPE = 'Step') STEPS on CONSTITUENT.ID = STEPS.CONSTITUENTID
		left join (select * from EJ_DONATION_ANNUAL_SUMMARY_REVENUE_RECOGNITION SUMMARY where SUMMARY.[TYPE] = 'Recognition') ANNUAL_SUMMARY_CASH on CONSTITUENT.ID = ANNUAL_SUMMARY_CASH.CONSTITUENTID
		left join EJ_DONATION_ANNUAL_SUMMARY_RECOGNITION_PAYMENT_AND_PLEDGE ANNUAL_SUMMARY_ACCRUAL on CONSTITUENT.ID = ANNUAL_SUMMARY_ACCRUAL.CONSTITUENTID
		left join EJ_MODELING_RATINGS MODELING on CONSTITUENT.ID = MODELING.CONSTITUENTID
		left join EJ_APPEAL_MAILINGS APPEALS on CONSTITUENT.ID = APPEALS.CONSTITUENTID
	) SUB
where EJ_CONSTITUENT_HISTORY.CONSTITUENTID = SUB.CONSTITUENTID
OPTION (OPTIMIZE FOR UNKNOWN)










